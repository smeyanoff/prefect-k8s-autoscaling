# ETL pipeline

## Description

Шаблон для выполнения python applications, используя Prefect.

1. Используйте версионирование, обновляйте version в pyproject.toml, т.к. она используется как тег при загрузке контейнера в regestry. Если не обновлять версию, версия контейнера может не обновиться в кубере.

#### Справка по версиям
Версия состоит из трех цифр разделенных точкой `0.1.0`

Первая цифра -- Мажорная версия, которая говорит о качественных изменениях и не гарантирует обратную совместимость.
Вторая цифра -- Минорная версия, добавление новой функциональности.
Третья цифра -- Патч, устранение багов и мелкие правки существующей функциональности

При разработке и тестировании может возникнуть необходимость тестировать функциональность в тестовой среде Prefect. Тогда версию можно указывать в `.env` файле. Чтобы не перегружать версионирование патчами при дебаггинге, нужно добавить к версии `-rc1, -rc2, ...` в зависимости от патча.
Тогда версия в `.env` будет выглядеть так - `0.1.0-rc1, 0.1.0-rc2 и т.д.`.

#### Про GitOps подход
При мердже в ветки `test` и `main` в удаленном репозитории запускается CI/CD процесс, который деплоит флоу в определенный work pool.
Ветки репозитория названы также, как и work pool'ы в prefect. Таким образом при мердже в тест, флоу деплоится в `test work pool`, при мердже в мейн - в `main`.
Весь CI описан в `.gitlab-ci.yml`

## Prerequisites

Чтобы запустить локально, необходимы следующие пакеты:

- make
- python (see version in pyproject.toml)

## Resources, Affinity и Tolerations

С помощью [affinity и tolerations](https://wiki.yandex.ru/ons-home/servisy/yandex-clo/managed-service-for-kubernetes/affinity-i-tolerations/) можно задать, на какую ноду, должен развернутся под.

Например, если нужен высокопроизводительный конфиг, можно выбрать более произовдительные группы нод.

Для ознакомления с максимальным количеством ресурсов для Job, перейдите на [страницу документации](https://wiki.yandex.ru/ons-home/servisy/yandex-clo/managed-service-for-kubernetes/taint-politiki-nod/)

affinity и tolerations указываются в prefect.yaml. Там же можно указать количество необходимых ресурсов.

## Makefile

Чтобы вызвать справку по Makefile `make help`

В Makefile можно найти полезные команды по инициализации проекта и установке зависимостей, линтерам, тестировании и деплое.
